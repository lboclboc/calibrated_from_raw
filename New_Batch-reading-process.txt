// macro: Calibrated_object files from Canon CR2 raw files
// new version

print ("Start batch reading process");
getDateAndTime(year,month,dow,day,h,m,s,msec);
t = ""+year+"-"+month+"-"+day+"T"+h+":"+m+":"+s;
print("\n-------------------- "+t+" --------------------");
print ("Setup input numbers and file directories:");

// Default gains, Canon 6D standard
gainRed   = 1.5; // red gain=1.5 normal for Canon sensors, change this to your cameras red gain rel green
gainGreen = 1.0; // gain for green channel is always set to 1
gainBlue  = 1.7; // blue gain=1.7 normal for Canon sensors, change this to your cameras blue gain rel green

// Input file format
// Note: Only works with some Canon EOS yet, Canon 350D, 5D and 6D tested
fileformat = newArray(4);
fileformat[0] = ".tif"; // TIFF from eralier run of process
fileformat[1] = ".cr2"; // Canon raw format
fileformat[2] = ".nef"; // Nikon raw format (experimental)
fileformat[3] = ".arw"; // Sony raw format (experimental)

// Do a master flat calibration
flatcalibrate = true;

// Input file name order
// Time is to prefer if there is a small drift because of bad polar align or a comet that moves relative stars.
filenameorder = newArray(2);
filenameorder[0] = "time"; // Time: 1001_Blue, 1001_Green1, 1001_Green2, 1001_Red, 1002_Blue, 1002_Green1, 1002_Green2, 1002_Red .......
filenameorder[1] = "color"; // Color: Red_1001, Red_1002, Red_1003 ...... Gren1_1001, Green1_1002, Green1_1003 .....

// File number serie, offset second batch if you want to merge them later
// offset: 1000, 2000, 3000 ...
offset = newArray(6);
offset[0] = 1000; // the default number
offset[1] = 2000; //
offset[2] = 3000; //
offset[3] = 4000; //
offset[4] = 5000; //
offset[5] = 6000; //

// Which colors to keep when demosaic ?
mosaicColor = newArray(4);
mosaicColor[0] = 1; // Red
mosaicColor[1] = 1; // Green1
mosaicColor[2] = 1; // Green2
mosaicColor[3] = 1; // Blue

// HDR gain, use this when doing HDR images example ISO1600/ISO400=4
hdrGain=1;

// if enabled extra data add to the end of filename
// set cameradata = "false" or cameradata = "true"
cameradata="false";
equipment="20200101 M45 etc"; // Extra info in file name

// Input box with parameters

Dialog.create("Setup batch reading process");

Dialog.addMessage("No need of bias and dark cal, read overscan data of the sensor.");
Dialog.addMessage("Batch reading raw files, flat calibrate, demosaic");
Dialog.addMessage("BATCH RAW READING DATA STARTS HERE:");
Dialog.addChoice("     Input files format:",fileformat,fileformat[1]); // Default = Canon cr2 raw files

Dialog.addMessage("When file format is Tiff it suppose to be CFA images, jumps direct to demosaicing");

Dialog.addMessage("Gain for each color channel :");
Dialog.addNumber("          Red gain : ",gainRed);
Dialog.addNumber("        Green gain : ",gainGreen);
Dialog.addNumber("         Blue gain : ",gainBlue);

Dialog.addMessage("HDR gain, ex ISO1600 / ISO400 = 4 :");
Dialog.addNumber("          HDR gain : ",hdrGain);

Dialog.addMessage("Flat calibrate ?");
Dialog.addCheckbox("    _flat calibrate",flatcalibrate);

Dialog.addMessage("File name order:");
Dialog.addChoice("Time or Color order : ",filenameorder,filenameorder[0]);

Dialog.addMessage("Set an offset to the base number to not mix them up later.");
Dialog.addChoice("   File name offset :",offset,offset[0]); // Default = 1000

Dialog.addMessage("Add extra info to filename ?");
Dialog.addCheckbox("Date, Object etc",cameradata);

Dialog.addMessage("Extra info at the end of file name :");
Dialog.addString("Date, Object etc : ", equipment);

Dialog.addMessage("DEMOSAICING STARTS HERE:");
Dialog.addMessage("Which colors to keep ?");
Dialog.addCheckbox("   Red : ", mosaicColor[0]);
Dialog.addCheckbox("Green1 : ", mosaicColor[1]);
Dialog.addCheckbox("Green2 : ", mosaicColor[2]);
Dialog.addCheckbox("  Blue : ", mosaicColor[3]);

Dialog.show();

// Save input from inputbox

filetype = Dialog.getChoice();
print("Filetype = ",filetype);

flatcal      = Dialog.getCheckbox();
print("Flat calibrate = ", flatcal);

redGain = Dialog.getNumber();
print("Gain Red = ", redGain);
greenGain = Dialog.getNumber();
print("Gain Green = ", greenGain);
blueGain = Dialog.getNumber();
print("Gain Blue = ", blueGain);

hdrGain = Dialog.getNumber();
print("HDR gain = ", hdrGain);

redHdrGain=redGain*hdrGain;
print("Red HDR gain = ", redHdrGain);
greenHdrGain=greenGain*hdrGain;
print("Green HDR gain = ", greenHdrGain);
blueHdrGain=blueGain*hdrGain;
print("Blue HDR gain = ", blueHdrGain);

order = Dialog.getChoice();
print("File name order = ", order);

offset = Dialog.getChoice();
print("Offset = ", offset);

cameradata = Dialog.getCheckbox();
print("Extra file info ? ", cameradata);

equipment      = Dialog.getString();
print("Extra file info = ", equipment);

mosaicColor[0] = Dialog.getCheckbox();
print("Keep Red : ", mosaicColor[0]);

mosaicColor[1] = Dialog.getCheckbox();
print("Keep Green1 : ", mosaicColor[1]);

mosaicColor[2] = Dialog.getCheckbox();
print("Keep Green2 : ", mosaicColor[2]);

mosaicColor[3] = Dialog.getCheckbox();
print("Keep Blue : ", mosaicColor[3]);

print(" Mosaic Colors = ", mosaicColor[0], mosaicColor[1], mosaicColor[2], mosaicColor[3]);